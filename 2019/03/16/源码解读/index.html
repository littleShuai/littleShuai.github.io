<!DOCTYPE HTML>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="机灵猴">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.1">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->

    <meta name="keywords" content="littleshuai">


    <meta name="description" content="YYCache 源码分析https://blog.ibireme.com/2015/10/26/yycache/
内存缓存：通常一个缓存是由内存缓存和磁盘缓存组成，内存缓存提供容量小但高速的存取...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>源码解读 | 机灵猴</title>


    <link rel="alternate" href="/atom.xml" title="机灵猴" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>






    

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header" style="background-image:url(http://snippet.shenliyang.com/img/banner.jpg)">
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="aHuang">
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 梦想成为扫地阿姨的程序媛 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://yoursite.com">机灵猴</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>Home</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/前端/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/后端/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/工具/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>时间轴</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="源码解读">
            
	            源码解读
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/03/16</span>
        </span>
        
    
</div>
            
            
    </div>
    
    <div class="post-body post-content">
        <h3 id="YYCache-源码分析"><a href="#YYCache-源码分析" class="headerlink" title="YYCache 源码分析"></a>YYCache 源码分析</h3><p><a href="https://blog.ibireme.com/2015/10/26/yycache/" target="_blank" rel="noopener">https://blog.ibireme.com/2015/10/26/yycache/</a></p>
<h4 id="内存缓存："><a href="#内存缓存：" class="headerlink" title="内存缓存："></a>内存缓存：</h4><p>通常一个缓存是由内存缓存和磁盘缓存组成，内存缓存提供容量小但高速的存取功能，磁盘缓存提供大量但低速的持久化存储。相对于磁盘缓存，内存缓存的设计要更简单些。<br>NSCache 是苹果提供的一个简单的内存缓存，它有着和NSDictionary类似的API，不同的是它是线程安全的，并且不会retain key。线程安全是由pthread_mutex完成的。性能和key的相似度有关，如果有大量相似的key，NSCache 的存取性能会下降的非常厉害，大量的时间被消耗在CFStringEqual() 上；<br>YYMemoryCache 去掉了异步访问的接口，尽量优化了同步访问的性能，用OSSpinLock 来保证线程安全。缓存内部用双向链表和 NSDictionary 实现了 LRU 淘汰算法；<br>YYKit 作者测试结果：<br>YYMemoryCache 的性能仅次于 NSDictionary + OSSpinLock；<br>NSCache 的写入性能稍差，读取性能不错；<br><!--阅读全文--> </p>
<h4 id="磁盘缓存："><a href="#磁盘缓存：" class="headerlink" title="磁盘缓存："></a>磁盘缓存：</h4><p>目前开源的第三方库和一些闭源的实现，包括NSURLCache、Facebook 的 FBDiskCache 等，他们的实现技术大致分为三类：基于文件读写、基于 mmap 文件内存映射、基于数据库；<br>比如 SDWebImage 的缓存是基于文件系统的，即一个value对应一个文件，通过文件读写来缓存数据。缺点：不便扩展，没有元数据，难以实现较好的淘汰算法，数据统计缓慢；<br>FastImageCache 采用的是 mmap 将文件映射到内存。用过 MongoDB 的人应该熟悉 mmap 的缺陷：热数据的文件不要超过物理内存大小，不然 mmap 会导致内存交换严重降低性能；另外内存中的数据时定时 flush 到文件的，如果数据还未同步时程序挂掉，就会导致数据错误。抛开这些缺陷来说，mmap 性能非常高；<br>NSURLCache、FBDiskCache 都是基于 SQLite 数据库的，基于数据库的缓存可以很好的支持元数据、扩展方便、数据统计速度快，也很容易实现LRU 或其他淘汰算法。但是SQLite 读取性能取决于数据大小：当单条数据小于20K时，数据越小 SQLite 读取性能越高；单条数据大于20K时，直接写为文件速度会更快一些。磁盘缓存最好是把SQLite 和文件存储结合起来。<br>YYDiskCache 也是采用的 SQLite 配合文件的存储方式，得益于 SQLite 存储的元数据，YYDiskCache 实现了 LRU 淘汰算法、更快的数据统计，更多的容量控制选项。此处 LRU 是双向链表配合 NSDictionary 实现的，增、删、改、查、清空的时间复杂度都是O（1），这个头文件注释里也有说明。这里的对象释放也是在特定的queue中释放，因为 OC 对象的释放也是比较消耗性能的，作者的目的应该是处于对性能的考虑，把 OC 对象放到子线程中去 release 。作者在《iOS 保持界面流畅的技巧》中提到了这一点。多线程下，QPS（每秒查询率）不会高于单线程，但会降低多少要看具体情况。由于 cache 内部使用锁来保证线程安全的，所以线程数越多、访问竞争越激烈、CPU 资源就消耗越大，QPS 也就越低。当然在实际APP开发中，一般使用时不会遇到这种极端情况。</p>
<h4 id="锁：（YYCache-线程安全的处理）"><a href="#锁：（YYCache-线程安全的处理）" class="headerlink" title="锁：（YYCache 线程安全的处理）"></a>锁：（YYCache 线程安全的处理）</h4><p>ASSpinLock 自旋锁，性能最高的锁。原理比较简单，就是一直 do while 忙等。他的缺点是当等待时会消耗大量的 CPU 资源，所以它不适用于较长时间的任务。对于内存缓存的存取来说，它非常合适；<br>dispatch_senaphonre 是持有计数的信号量，该计数时多线程变成中的技术类型信号。所谓信号，类似于过马路时常用的手旗，可以通过时举起手旗，不可通过时放下手旗。而dispatch_semaphore 使用计数来实现该功能。当信号总量设为 1 时也可以当做锁来看。在没有等待情况出现时，它的性能比 pthread_mutex （互斥锁）还要高，但一旦有等待情况出现时，性能就会下降很多。相对于OSSpinLock 来说，它的优势在于等待时不会消耗 CPU 资源。对磁盘缓存还说，它比较合适。</p>
<!-- ![meinv](../images/meinv.jpg) -->
<h4 id="YYMemoryCache-分层解读："><a href="#YYMemoryCache-分层解读：" class="headerlink" title="YYMemoryCache 分层解读："></a>YYMemoryCache 分层解读：</h4><h5 id="设计思路："><a href="#设计思路：" class="headerlink" title="设计思路："></a>设计思路：</h5><p>系统的 NSCache 读写很快，写入的时候由于 key 的原因稍微慢点，但是对缓存的 totalCostLimit 自动清除缓存却是不可控制的。YYMemoryCache 是对NSCache 进行改造或者站在 NSCache 的设计思路上，进一步提供比较快的写入速度，提供自动清除的可控性。NSDictionary 有 NSCache 一样需要的 key-value 对，读取速度非常快。对于控制清除缓存方面可以写入由时间先后来决定，写入value的时候带上时间并放到一个队列的前面，读取的时候把该 value 放到前面（MRU），清除的时候从最后面开始（LRU）。那么这个队列应该由什么来控制呢？<br>数组内存空间连续，读取速度快，但是修改速度慢，但是现在我们需要的是修改速度比较快的就行了，读取上已经有了 NSDictionary 。链表是修改速度非常快的队列，存储上内存空间不连续。虽然读取的时候慢点，但是我们不需要用它来读取，而且链表也能提供头尾的操作，很符合LRU。所以最终的模式是：NSDictionary + 双线链表 + LRU + （NSCache的线程安全 + 内存警告处理 + 转入后台处理 + 实时 limit 处理）。</p>
<h5 id="封装："><a href="#封装：" class="headerlink" title="封装："></a>封装：</h5><p>交互层，YYMemoryCache.h/m 这个类提供外部的接口，类似于 NSCache。<br>处理层，YYLinkedMap.h/m 这个内部的类来响应交互层的 command，提供数据的读写，删除，也就是双向链表和字典的操作；<br>组件层，YYLinkedMapNode.h/m 这是链表的节点类。<br>LRU 算法原理：<br>用双向链表表示堆栈，新加入的数据存在栈顶，使用缓存的数据的时候，从栈中查找，如果命中，就把数据移到栈顶，可以设置栈最大长度，超过长度就把栈尾的数据删除；</p>
<h5 id="线程安全控制（锁）："><a href="#线程安全控制（锁）：" class="headerlink" title="线程安全控制（锁）："></a>线程安全控制（锁）：</h5><p>（在分析 YYCache 的时候，我发现作者用了很多锁来保证线程的安全。这是值得我学习的地方，因为以前很少考虑过线程安全的问题。）<br>在 YYCache 中主要用了2中锁：pthread_mutex  和 dispatch_semaohore ：pthread_mutex 其实也是利用OSSpinLock 实现的，还有其他的一些锁比如 NSLock、@synchronized 这些使用也很方便，OSSpinLock 相对性能最高，@synchronized 相对性能差些。线程安全就是说多线程访问同一代码，不会产生不确定的结果，如果在执行代码前加锁，只有等这段代码完成后才解锁，这样就不会出现因多线程而出现竞争资源等问题，从而实现线程安全；</p>
<h5 id="双向链表结构："><a href="#双向链表结构：" class="headerlink" title="双向链表结构："></a>双向链表结构：</h5><p>链表的节点（YYLinkedMapNode）：包含上一个节点指针，下一个节点指针，key值，value值，节点开销大小，缓存时间戳等部分；<br>链表（YYLinkedMap）：字典的Ref，链表总开销，链表个数，链表首个节点指针，链表末尾节点指针，是否在主线程释放内存，是否异步释放内存等，链表节点的增、删、改、查等操作。<br>_YYLinkedMapNode <em>node = CFDictionaryGetValue(_lru-&gt;_dic,(__bridge const void </em>)(key)); 这句代码就相当于 NSMutableDictionary objectForKey，取出链表节点，这个 NSMutableDictionary 里面装的是&lt;_YYLinkedMapNode *&gt;；</p>
<h5 id="定时清理："><a href="#定时清理：" class="headerlink" title="定时清理："></a>定时清理：</h5><p>这就是区别普通 NSDictionary 缓存的地方之一，不断在后台更新缓存数据，清理过去数据，只要设置一个_autoTrimInterval 时间间隔就好。这里用了定时器和递归处理；</p>
<h5 id="YYDiskCache-分层解读："><a href="#YYDiskCache-分层解读：" class="headerlink" title="YYDiskCache 分层解读："></a>YYDiskCache 分层解读：</h5><h5 id="YYKVStorage："><a href="#YYKVStorage：" class="headerlink" title="YYKVStorage："></a>YYKVStorage：</h5><p>要解析YYDiskCache 首先得解析 YYKVStorage，该文件主要以2中方式实现磁盘存储：SQLite 和 File，使用2中方式混合进行存储主要为了提高读写效率。写入数据时，SQLite 要比文件的方式更快，读取数据的速度主要取决于文件的大小；据测试，在iPhone 6中，当文件大小超过20kb时，File 要比 SQLite 快的多，所以大文件存储时建议用 File 方式，小文件更适合用 SQLite；所以这里用2中方式混合主要还是考虑到存储的速度；<br>添加数据 saveItemWithKey：… 主要流程是先判断要缓存的数据是否为空，然后判断数据类型，如果是 File 那么久用文件存储的方式进行存储，如果文件存储失败改用 SQLite 进行存储，如果 SQLite 存储也失败，那么久直接删除本地文件存储；如果数据不是 File 类型 那么就直接用 SQLite 方式存储。读取数据的流程与添加数据类似。</p>
<h5 id="YYDiskCache："><a href="#YYDiskCache：" class="headerlink" title="YYDiskCache："></a>YYDiskCache：</h5><p>YYDiskCache 的核心内容就是 YYKVStorage，他是 YYKVStorage 的扩展；</p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href target="_blank">Snippet</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2019/03/20/数据同步/" class="pre-post btn btn-default" title="数据同步">
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">数据同步</span>
        </a>
    
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'xOKV9J4UeQAtVkvnJC7Kq2Jn-gzGzoHsz',
            appKey: 'erIpQac4azoCmgfBB7Dl9maa',
            placeholder: '说点什么吧',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-Hans'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">Table of Contents</h3>
        
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYCache-源码分析"><span class="toc-text">YYCache 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内存缓存："><span class="toc-text">内存缓存：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#磁盘缓存："><span class="toc-text">磁盘缓存：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#锁：（YYCache-线程安全的处理）"><span class="toc-text">锁：（YYCache 线程安全的处理）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YYMemoryCache-分层解读："><span class="toc-text">YYMemoryCache 分层解读：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#设计思路："><span class="toc-text">设计思路：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#封装："><span class="toc-text">封装：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#线程安全控制（锁）："><span class="toc-text">线程安全控制（锁）：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#双向链表结构："><span class="toc-text">双向链表结构：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#定时清理："><span class="toc-text">定时清理：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#YYDiskCache-分层解读："><span class="toc-text">YYDiskCache 分层解读：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#YYKVStorage："><span class="toc-text">YYKVStorage：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#YYDiskCache："><span class="toc-text">YYDiskCache：</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2017
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>